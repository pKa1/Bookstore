## Подробное описание системы и функционала

### 1. Общее описание
Книжный магазин — веб‑приложение с ролями Администратор, Работник и Клиент. Приложение позволяет:
- Администратору управлять пользователями, книгами, клиентами, работниками и заказами, а также выгружать данные в Excel.
- Работнику работать с клиентами, работниками, книгами и заказами, просматривать/редактировать и создавать заказы, экспортировать данные.
- Клиенту просматривать каталог книг, добавлять книги в корзину и оформлять заказ.

Архитектура основана на Express (Node.js) с серверным рендерингом через Nunjucks и локальным хранилищем SQLite. Взаимодействие клиентской части с сервером происходит по REST API (JSON) через AJAX.

### 2. Роли и права
- Admin: полный доступ, включая управление пользователями и экспорт всех данных.
- Worker: доступ к клиентам, работникам, книгам и заказам (CRUD), экспорт книг и заказов.
- Client: видит только каталог «Книги» и «Корзину», оформляет заказы; видит только свои заказы (отфильтрованы по `clients.user_id`).

### 3. Жизненный цикл запроса
1) Запрос приходит в Express → логирование (morgan) → раздача статики (при необходимости) → парсинг тела (JSON/URL‑encoded).
2) Сессия (express‑session + connect‑sqlite3) извлекается/создаётся; в `res.locals` записываются `currentUser` и `roles` для шаблонов.
3) Маршрут (SSR или API) обрабатывается с учётом middleware доступа (`ensureAuthenticated`, `ensureRole`).
4) Ответ: для страниц — рендер Nunjucks‑шаблонов; для API — JSON.
5) Обработчики 404/500 возвращают корректные HTML/JSON ответы.

### 4. Структура проекта
- `app.js`: конфигурация сервера, шаблоны, сессии, общие middleware, маршруты, обработка ошибок.
- `db.js`: создание/инициализация БД, сиды демо‑данными, миграция (добавление `clients.user_id`).
- `auth.js`: аутентификация (bcrypt), регистрация, middleware для проверки роли/логина.
- `routes/pages.js`: SSR‑маршруты (логин/регистрация, дашборд, сущности).
- `routes/api.js`: REST API (пользователи/работники/клиенты/книги/заказы/корзина).
- `routes/export.js`: выдача Excel файлов (пользователи, книги, заказы + позиции).
- `templates/*.html`: шаблоны Nunjucks (Bootstrap 5 + Select2).
- `static/js/app.js`: клиентская логика страниц (AJAX, таблицы, модалки, Select2).
- `static/css/style.css`: общие стили и мобильные корректировки.
- `test/api.spec.js`: пример базового теста API (Mocha + Supertest).
- `docs/STACK.md`: обзор стека и архитектуры.
- `docs/ARCHITECTURE.md`: текущий подробный документ.

### 5. Схема и связи данных (SQLite)
- `users(id, login, password_hash, role, created_at)`
- `employees(id, full_name, position, contact)`
- `clients(id, full_name, contact, notes, user_id)` — `user_id` уникально и ссылается на `users.id`
- `books(id, title, author, price, quantity)`
- `orders(id, client_id, created_at, status)` — `client_id` → `clients.id`
- `order_items(id, order_id, book_id, quantity, price)` — ссылки на `orders` и `books`

Особенности:
- Включены `PRAGMA foreign_keys=ON` и `journal_mode=WAL` для целостности/производительности.
- Сид‑данные: три пользователя (admin/worker/client), несколько клиентов/книг и пример заказа.
- Миграция: добавление поля `clients.user_id` и привязка первого клиента к пользователю `client`.

### 6. API (основные конечные точки)
Все ответы — JSON. Пагинация: `page`, `pageSize` (LIMIT/OFFSET). Требует аутентификации (и роли при необходимости).

Пользователи (только Admin):
- GET `/api/users`
- POST `/api/users` — создание (login, password, role)
- PUT `/api/users/:id` — смена роли, опционально пароля
- DELETE `/api/users/:id`

Работники (Admin/Worker):
- GET `/api/employees`
- POST `/api/employees`
- PUT `/api/employees/:id`
- DELETE `/api/employees/:id` (Admin)

Клиенты (Admin/Worker):
- GET `/api/clients`
- POST `/api/clients`
- PUT `/api/clients/:id`
- DELETE `/api/clients/:id` (Admin)

Книги (все вошедшие — чтение; Admin/Worker — запись):
- GET `/api/books?q=...`
- POST `/api/books`
- PUT `/api/books/:id`
- DELETE `/api/books/:id` (Admin)

Заказы:
- GET `/api/orders` — Admin/Worker видят все; Client видит только свои (фильтр по `clients.user_id`)
- GET `/api/orders/:id/items` — позиции заказа
- POST `/api/orders` (Admin/Worker) — создание заказа по клиенту
- PUT `/api/orders/:id` — смена статуса
- DELETE `/api/orders/:id` (Admin)

Корзина (Client):
- GET `/api/cart` — содержимое корзины из сессии
- POST `/api/cart` — добавление книги (проверка остатка; нельзя превышать `books.quantity`)
- DELETE `/api/cart/:book_id` — удаление позиции
- POST `/api/cart/checkout` — оформление заказа:
  - Находит/создаёт `clients` по текущему `users.id`.
  - Проверяет остатки, создаёт `orders` и `order_items`, списывает `books.quantity`.
  - Возвращает `id` заказа, очищает корзину.

### 7. Страницы и клиентская логика
Шаблоны Nunjucks используют Bootstrap 5 для каркаса и Select2 для UX в модалках. Клиентская логика в `static/js/app.js` реализует:
- Таблицы со списками (книги, клиенты, работники, заказы, пользователи), пагинация (простая), действия CRUD через AJAX.
- Модалки создания/редактирования сущностей; на мобильных — полноэкранные (`modal-fullscreen-sm-down`).
- Для заказов: 
  - Админ/Работник могут создавать заказ: выбор клиента (Select2), добавление позиций (книга, цена, кол‑во, сумма).
  - Просмотр позиций заказа в отдельной модалке.
- Для клиента: 
  - На странице «Книги» кнопка «В корзину» доступна только при `quantity > 0`.
  - «Корзина»: удаление позиций, оформление заказа; после успеха — toast и редирект на «Книги».

### 8. Экспорт в Excel
Маршруты:
- `/export/users.xlsx` (Admin)
- `/export/books.xlsx` (Admin/Worker)
- `/export/orders.xlsx` (Admin/Worker) — два листа: «Заказы» (с локализованным статусом) и «Позиции» (книга, кол‑во, цена, сумма).

### 9. Локализация статусов
Статусы заказов хранятся как `new|paid|shipped|cancelled`, но отображаются на русском (в таблицах, модалках и Excel): «Новый», «Оплачен», «Отгружен», «Отменён».

### 10. Ошибки и обработка
- 404: HTML или JSON в зависимости от заголовков `Accept`.
- 500: централизованный обработчик (лог + понятный ответ).
- Корзина/чекаут: подробные сообщения валидации (нет книги, нет остатков, пустая корзина и т.д.).

### 11. Конфигурация
- `PORT` — порт HTTP сервера (по умолчанию 3000).
- `SESSION_SECRET` — секрет для подписывания сессии.
- Директория `data/` содержит `bookstore.sqlite` и `sessions.sqlite`.

### 12. Безопасность
- Хеширование паролей через `bcryptjs`.
- Сессии в SQLite, cookie с разумным временем жизни.
- Ролевой контроль на уровне маршрутов.
- Рекомендации: добавить CSRF‑защиту, helmet, ограничение скорости (rate‑limit) в продакшене.

### 13. Производительность и масштабирование
- Небольшое приложение с локальной SQLite: подходит для MVP/внутренних решений.
- При росте нагрузки: вынести сессии в Redis, мигрировать на внешнюю БД (Postgres/MySQL) и асинхронные очереди для тяжёлых задач.

### 14. Тестирование
- Mocha + Supertest: базовые интеграционные тесты API.
- Рекомендуется расширять: сценарии CRUD, валидации, роли и негативные кейсы.

### 15. Деплой и эксплуатация
- Рекомендуется Node 20 LTS.
- Docker: базовый образ node:20‑alpine и volume для `data/`.
- Логи: stdout/stderr (morgan для HTTP).

### 16. Расширение функционала
- Добавить уведомления (email/Telegram) при новых заказах.
- Валидация входных данных на уровне API (например, zod/celebrate).
- Расширить аналитику и отчёты (по клиентам, авторам, товарам).
- Импорт/экспорт каталога книг (CSV/Excel).


